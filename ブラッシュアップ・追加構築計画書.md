# Pic_cul システム ブラッシュアップ・追加構築 計画書

## 📋 プロジェクト概要

**プロジェクト名**: Pic_cul - 店舗メニュー管理システム  
**コンセプト**: SNS風UI/UXを持つメニュー管理・表示プラットフォーム  
**強化方針**: 単なるデジタルメニューを超え、集客・分析ツールとしての価値を創出

---

## 🎨 デザイン原則

- **Apple Human Interface Guidelines準拠**
- **フィードの没入感**: フルスクリーン表示
- **ナビゲーション改善**: タブバー化

---

## 🗄️ コアデータ構造の変更

### データ一元化
- **変更内容**: 週間・月間メニューテーブルを廃止し、`menus`テーブルに統合
- **管理方法**: `menu_type`で管理（`daily`, `weekly`, `monthly`）
- **メリット**: 
  - データ構造の簡素化
  - クエリの統一化
  - メンテナンス性の向上

---

## 🛠️ I. 必須ブラッシュアップ（既存仕様の改善・セキュリティ）

### 1. セキュリティ強化

#### 改善内容
- JWTトークンを**HttpOnly Cookie**で保存し、XSSリスクを低減

#### 影響範囲
- 認証システム全体
- フロントエンド: `/admin/login`
- バックエンド: `/api/auth/admin/login`

#### 実装内容
- [ ] バックエンド: Cookie設定の追加（HttpOnly, Secure, SameSite）
- [ ] フロントエンド: localStorageからCookieへの移行
- [ ] 認証ミドルウェアの更新

#### 優先度: 🔴 高

---

### 2. UX/画像処理改善

#### 改善内容
- 画像アップロードを`multipart/form-data`に変更
- 進捗表示でアップロード体験を改善

#### 影響範囲
- 日間メニュー投稿（B-1）
- フロントエンド: `/admin/menus/new`
- バックエンド: `/api/menus/daily`, `/api/upload`

#### 実装内容
- [ ] フロントエンド: FormDataを使用したアップロード
- [ ] 進捗バーの実装（XMLHttpRequestまたはfetch with progress）
- [ ] バックエンド: Multerを使用したファイル受信
- [ ] 画像リサイズ・最適化機能の追加

#### 優先度: 🟡 中

---

### 3. パスワードリセット機能

#### 改善内容
- パスワードリセット機能を実装し、店舗オーナーの利便性を確保

#### 影響範囲
- 管理者機能（A-3）
- フロントエンド: `/admin/reset-password`
- バックエンド: `/api/auth/reset-password`, `/api/auth/reset-password/verify`

#### 実装内容
- [ ] パスワードリセットリクエスト画面
- [ ] メール送信機能（または店舗ID確認）
- [ ] リセットトークン生成・検証
- [ ] 新パスワード設定画面

#### 優先度: 🟡 中

---

### 4. 表現力強化

#### 改善内容
- 週間/月間メニューに画像登録を任意項目として追加

#### 影響範囲
- 週間メニュー設定（B-2）
- 月間メニュー設定（B-3）
- データベース: `weekly_menus`, `monthly_menus`テーブル（または統合後の`menus`テーブル）

#### 実装内容
- [ ] データベース: `image_url`カラムの追加
- [ ] フロントエンド: 画像アップロードUIの追加
- [ ] バックエンド: 画像保存処理の追加

#### 優先度: 🟢 低

---

## 🚀 II. 新規追加機能（付加価値の創出）

### 1. ユーザーリアクション機能

#### 機能名
**いいね/コメント機能**

#### 目的と概要
- ユーザーがメニューに「いいね」を付けられるようにする
- 将来的にコメント機能も追加可能な設計

#### データベース
```sql
CREATE TABLE menu_reactions (
  id UUID PRIMARY KEY,
  menu_id UUID REFERENCES menus(id) ON DELETE CASCADE,
  user_id TEXT, -- セッションIDまたは匿名ID
  reaction_type VARCHAR(20) DEFAULT 'like',
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(menu_id, user_id, reaction_type)
);
```

#### API
- `POST /api/menus/:id/like` - いいねを付ける/外す
- `GET /api/menus/:id/reactions` - いいね数を取得

#### フロントエンド
- フィード画面にいいねボタンを追加
- いいね数の表示
- アニメーション効果

#### 優先度: 🟡 中

---

### 2. 検索性向上

#### 機能名
**ハッシュタグ検索**

#### 目的と概要
- メニューに`#限定`などのタグ付けを可能にする
- ユーザーがメニューを絞り込みやすくする

#### データベース
```sql
CREATE TABLE menu_tags (
  id UUID PRIMARY KEY,
  menu_id UUID REFERENCES menus(id) ON DELETE CASCADE,
  tag_name VARCHAR(50) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(menu_id, tag_name)
);

CREATE INDEX idx_menu_tags_tag ON menu_tags(tag_name);
```

#### API
- `GET /api/menus/search?tag=限定` - タグで検索
- `GET /api/tags/popular` - 人気タグ一覧

#### フロントエンド
- メニュー投稿時にタグ入力欄を追加
- 検索バーでタグ検索
- タグ一覧表示

#### 優先度: 🟡 中

---

### 3. 店舗分析機能

#### 機能名
**簡易アクセス解析**

#### 目的と概要
- 管理者ダッシュボードにアクセスサマリーや人気メニューTOP5を表示
- メニュー改善に活用

#### データベース
- 既存の`user_accesses`テーブルを活用
- `menu_reactions`テーブルから人気メニューを算出

#### API
- `GET /api/admin/analytics/summary` - アクセスサマリー
- `GET /api/admin/analytics/popular-menus` - 人気メニューTOP5
- `GET /api/admin/analytics/access-trends` - アクセストレンド

#### フロントエンド
- ダッシュボードに分析セクションを追加
- グラフ表示（Chart.js等）
- 期間選択機能

#### 優先度: 🟢 低

---

### 4. 運用効率向上

#### 機能名
**イチオシメニュー固定**

#### 目的と概要
- 特定のメニューをフィード最上部にピン留めできるようにする

#### データベース
- `menus`テーブルに`is_pinned`カラムを追加（BOOLEAN）

#### API
- `PUT /api/menus/:id/pin` - ピン留め/解除
- `GET /api/menus/daily/:store_id` - ピン留めメニューを最上部に表示

#### フロントエンド
- 管理者画面にピン留めボタンを追加
- フィード画面でピン留めメニューを最上部に表示

#### 優先度: 🟢 低

---

## 💻 III. 技術・データベース修正

### データベース変更

#### 1. テーブル統合
```sql
-- 週間・月間メニューテーブルを削除
DROP TABLE IF EXISTS weekly_menus;
DROP TABLE IF EXISTS monthly_menus;

-- menusテーブルに統合（既存のmenu_typeで管理）
-- 追加カラム
ALTER TABLE menus ADD COLUMN IF NOT EXISTS day_of_week INTEGER;
ALTER TABLE menus ADD COLUMN IF NOT EXISTS week_start_date DATE;
ALTER TABLE menus ADD COLUMN IF NOT EXISTS month INTEGER;
ALTER TABLE menus ADD COLUMN IF NOT EXISTS year INTEGER;
ALTER TABLE menus ADD COLUMN IF NOT EXISTS is_pinned BOOLEAN DEFAULT FALSE;
```

#### 2. 新規テーブル追加
- `menu_reactions` - いいね/リアクション
- `menu_tags` - ハッシュタグ

### API追加

#### 認証関連
- `POST /api/auth/reset-password` - パスワードリセットリクエスト
- `POST /api/auth/reset-password/verify` - リセットトークン検証
- `POST /api/auth/reset-password/confirm` - 新パスワード設定

#### メニュー関連
- `POST /api/menus/:id/like` - いいね
- `GET /api/menus/:id/reactions` - リアクション取得
- `GET /api/menus/search` - 検索（タグ、キーワード）
- `PUT /api/menus/:id/pin` - ピン留め

#### 分析関連
- `GET /api/admin/analytics/summary` - サマリー
- `GET /api/admin/analytics/popular-menus` - 人気メニュー
- `GET /api/admin/analytics/access-trends` - アクセストレンド

#### タグ関連
- `GET /api/tags/popular` - 人気タグ
- `GET /api/tags` - タグ一覧

### フロントエンド変更

#### 1. ナビゲーション改善
- ユーザー画面にタブバーを実装
  - 「本日のメニュー」
  - 「週間」
  - 「月間」
  - 「プロフィール」

#### 2. フィード画面改善
- フルスクリーン表示
- スワイプ操作対応
- いいねボタン追加
- ピン留めメニューの表示

#### 3. 管理者画面改善
- パスワードリセット画面
- 分析ダッシュボード
- ピン留め機能

---

## 📅 実装スケジュール（推奨）

### Phase 1: セキュリティ強化（最優先）
1. JWT Cookie化
2. パスワードリセット機能

### Phase 2: UX改善
1. 画像アップロード改善
2. タブバー実装
3. フィード画面改善

### Phase 3: データ構造変更
1. テーブル統合
2. データ移行スクリプト

### Phase 4: 新機能追加
1. いいね機能
2. ハッシュタグ検索
3. ピン留め機能
4. 分析機能

---

## 🔍 実装時の注意点

### データ移行
- 既存の週間・月間メニューデータを`menus`テーブルに移行する必要がある
- 移行スクリプトを作成し、テスト環境で検証

### 後方互換性
- 既存APIとの互換性を保つため、段階的な移行を推奨
- 旧エンドポイントを一定期間維持

### パフォーマンス
- いいね数の集計はキャッシュを活用
- インデックスの最適化

---

## 📊 成功指標

- **セキュリティ**: XSS攻撃のリスク低減
- **UX**: 画像アップロード成功率の向上
- **エンゲージメント**: いいね数の増加
- **検索性**: タグ検索の利用率
- **分析**: ダッシュボードのアクセス頻度

---

**作成日**: 2025年11月13日  
**バージョン**: 2.0.0（計画）











